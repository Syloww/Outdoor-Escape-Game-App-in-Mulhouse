<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pigeon Adventure GPS</title>
    <link rel="stylesheet" href="styles/dialogue.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <!-- Font Awesome pour les icônes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Style général amélioré */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            overflow: hidden;
            touch-action: manipulation;
        }

        #map-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #121a25;
            z-index: 1000;
            flex-direction: column;
            box-shadow: 0 -5px 25px rgba(0, 0, 0, 0.5);
        }

        /* Conteneur de la carte */
        .map-wrapper {
            position: relative;
            flex: 1;
            width: 100%;
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* Bouton de fermeture amélioré */
        #close-map {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: white;
            font-size: 18px;
            cursor: pointer;
            z-index: 1001;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            transition: all 0.2s ease;
        }

        #close-map:hover {
            background: rgba(255, 255, 255, 0.9);
            color: #000;
            transform: scale(1.1);
        }

        /* Panneau d'instructions amélioré */
        #instructions-container {
            background: #1e293b;
            color: #fff;
            padding: 0;
            height: 30%;
            max-height: 30%;
            display: flex;
            flex-direction: column;
            border-top: 2px solid #334155;
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.3);
        }

        .instructions-header {
            background: #0f172a;
            padding: 10px 15px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #334155;
        }

        #instructions {
            flex: 1;
            overflow-y: auto;
            padding: 10px 15px;
            scroll-behavior: smooth;
        }

        .instruction-step {
            margin-bottom: 12px;
            padding: 10px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.05);
            border-left: 3px solid transparent;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
        }

        .instruction-step i {
            margin-right: 10px;
            color: #60a5fa;
            font-size: 14px;
        }

        .current-step {
            background: rgba(59, 130, 246, 0.15);
            border-left: 3px solid #3b82f6;
            font-weight: 500;
        }

        .distance-info {
            margin-left: auto;
            background: #334155;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            color: #e2e8f0;
        }

        /* Bouton de localisation */
        .locate-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.2s ease;
        }

        .locate-btn:hover {
            background: white;
            transform: scale(1.05);
        }

        .locate-btn i {
            color: #1e40af;
            font-size: 20px;
        }

        /* Animation de chargement GPS */
        .gps-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            z-index: 1001;
            font-size: 14px;
        }

        .gps-loading i {
            margin-right: 10px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Style pour le dialogue */
        .dialogue-link {
            color: #3b82f6;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .dialogue-link:hover {
            color: #2563eb;
            text-decoration: underline;
        }

        /* Style pour le marqueur de position */
        .user-location-marker {
            background: #3b82f6;
            border: 2px solid white;
            border-radius: 50%;
            width: 15px;
            height: 15px;
            position: relative;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.3);
        }
    </style>
</head>

<body>
    <div id="map-container">
        <div class="map-wrapper">
            <div id="map"></div>
            <button id="close-map" title="Fermer la carte"><i class="fas fa-times"></i></button>
            <button class="locate-btn" id="locate-btn" title="Centrer sur ma position"><i class="fas fa-location-arrow"></i></button>
            <div class="gps-loading" id="gps-loading" style="display: none;">
                <i class="fas fa-satellite-dish"></i> Recherche du signal GPS...
            </div>
        </div>
        
        <div id="instructions-container">
            <div class="instructions-header">
                <span>Directions vers Mirror Door</span>
                <span id="total-distance">--</span>
            </div>
            <div id="instructions"></div>
        </div>
    </div>

    <div class="pigeon-container">
        <img src="images/pigeon.png" alt="pigeon" class="pigeon">
    </div>
    <div class="dialogue-box">
        <span id="dialogue-text"></span>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet Routing Machine JS -->
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <!-- Custom red icon for marker -->
    <script>
        // Création d'une icône rouge personnalisée
        const redIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });
    </script>

    <script>
        const phrases = [
            "Before I tell you my story, come and see me at the mirror door.",
            "Here I am in front of the Mirror Gate... Did you know that this place has quite a history? It all began in 1852 with Madame Koechlin, a great lady of Mulhouse. She set up the Comités de Patronage to help people in their own homes. In 1923, this district became the Patronage du Quartier Sud, then in 1957, the Centre Social Pont d'Altkirch, thanks to Madame Dolfus. It was a place for care and meetings...",
            "...but today it's also a place where some mad scientists put this tracking collar on me! I've managed to escape from their lab, but to really be free, I have to deactivate three modules hidden around Mulhouse. And guess what? The first is right here, in this garden full of mysteries. So let's get on with the adventure!",
            "First, off to the Garden of Fragrance! The first module is hidden away in a corner. Use the map to find your way!",
            "Created in 1987, this 1,500 m² garden was designed by ophthalmologist Dr Rolf Benner to help blind and partially sighted people use their sense of smell and touch to find their way around.",
            "I'm allergic to pollen, so I can hardly see anything. I have to pop all the balloons by following their sound: only the ones that beep sharply! The others are trapped and spread pollen. By ear and sneezing, I pop them one by one until the last one explodes.",
            "Yippee! I did it! Thanks for helping me!!! Now cape to the Gambrinus!",
            "Here I am in front of the Gambrinus, the liveliest bar in Mulhouse. My sensor is flashing: to deactivate it, you have to pour EXACTLY the right amount into the marked glass!",
            "Yippee! I did it! Thank you for helping me! Finally, we meet on the place de la reunion opposite the historical museum.",
            "The statue on the Place de la Réunion in Mulhouse represents William Tell, the legendary Swiss hero. According to tradition, he was forced by the Austrian governor Gessler to shoot an arrow at an apple placed on his son's head. His perfect shot made him a symbol of resistance and freedom. This statue is a reminder of the historic links between Mulhouse and Switzerland, before the town joined France in 1798.",
            "I've almost done it! The collar is half deactivated, but to blow it up DEFINITELY, I still have to do the ultimate test: The Dart Shot",
            "Yippee! I did it! Thank you for helping me!!! Now I'm going back to my life as a heroic pigeon! Maybe one day we'll meet up again for a new adventure... In the meantime, stay smart like a pigeon!"
        ];
        
        const dialogueElement = document.getElementById('dialogue-text');
        let phraseIndex = 0;
        let charIndex = 0;
        let isTyping = false;
        let typingTimeout;
        let isMapOpen = false;
        let map, routingControl, userMarker, watchId, accuracyCircle;
        let currentRouteInstructions = [];
        let currentStepIndex = 0;
        let totalDistance = 0;

        // Coordonnées exactes de la mirror door
        const mirrorDoorCoords = [47.748381528597086, 7.333458419631289];
        
        function initMap() {
            // Créer la carte centrée sur la destination
            map = L.map('map', {
                zoomControl: true,
                doubleClickZoom: true,
                closePopupOnClick: true,
                tap: true
            }).setView(mirrorDoorCoords, 17);
            
            // Ajouter la couche de tuiles OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                detectRetina: true
            }).addTo(map);
            
            // Marqueur ROUGE pour la destination (mirror door)
            L.marker(mirrorDoorCoords, {icon: redIcon}).addTo(map)
                .bindPopup("<b>Mirror Door</b><br>Destination")
                .openPopup();
            
            // Démarrer le suivi GPS
            startGPSTracking();
        }
        
        function startGPSTracking() {
            document.getElementById('gps-loading').style.display = 'flex';
            
            if (navigator.geolocation) {
                // Options pour une haute précision
                const options = {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                };
                
                // Démarrer le watchPosition pour un suivi continu
                watchId = navigator.geolocation.watchPosition(
                    position => updatePosition(position),
                    error => handleGeolocationError(error),
                    options
                );
            } else {
                alert("La géolocalisation n'est pas supportée par votre navigateur.");
                map.setView(mirrorDoorCoords, 8);
                document.getElementById('gps-loading').style.display = 'none';
            }
        }
        
        function updatePosition(position) {
            document.getElementById('gps-loading').style.display = 'none';
            
            const userCoords = [position.coords.latitude, position.coords.longitude];
            const accuracy = position.coords.accuracy;
            
            // Créer ou mettre à jour le marqueur de position
            if (!userMarker) {
                userMarker = L.circleMarker(userCoords, {
                    radius: 8,
                    fillColor: "#3b82f6",
                    color: "#fff",
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);
                
                // Ajouter un cercle de précision
                accuracyCircle = L.circle(userCoords, {
                    color: '#3b82f6',
                    fillColor: '#3b82f6',
                    fillOpacity: 0.2,
                    radius: accuracy
                }).addTo(map);
                
                // Calculer l'itinéraire initial
                calculateRoute(userCoords);
                
                // Centrer la carte sur la position
                map.setView(userCoords, 17);
            } else {
                userMarker.setLatLng(userCoords);
                accuracyCircle.setLatLng(userCoords).setRadius(accuracy);
            }
            
            // Vérifier la progression vers la destination
            if (currentRouteInstructions.length > 0) {
                checkProgress(userCoords, currentRouteInstructions);
            }
        }
        
        function calculateRoute(startCoords) {
            if (routingControl) {
                map.removeControl(routingControl);
            }
            
            // Configurer le contrôle d'itinéraire avec une ligne bleue
            routingControl = L.Routing.control({
                waypoints: [
                    L.latLng(startCoords[0], startCoords[1]),
                    L.latLng(mirrorDoorCoords[0], mirrorDoorCoords[1])
                ],
                routeWhileDragging: false,
                showAlternatives: false,
                fitSelectedRoutes: false,
                show: false,
                collapsible: true,
                addWaypoints: false,
                draggableWaypoints: false,
                language: 'fr',
                lineOptions: {
                    styles: [{color: 'red', opacity: 0.9, weight: 6}]
                },
                createMarker: function() { return null; }
            }).addTo(map);
            
            // Écouter les événements de routage
            routingControl.on('routesfound', function(e) {
                const routes = e.routes;
                const instructions = routes[0].instructions;
                currentRouteInstructions = instructions;
                totalDistance = Math.round(routes[0].summary.totalDistance);
                
                // Mettre à jour la distance totale
                document.getElementById('total-distance').textContent = `${totalDistance} m`;
                
                // Mettre à jour le panneau d'instructions
                updateInstructionPanel(instructions, 0);
            });
        }
        
        function updateInstructionPanel(instructions, stepIndex) {
            const instructionsContainer = document.getElementById('instructions');
            instructionsContainer.innerHTML = '';
            currentStepIndex = stepIndex;
            
            instructions.forEach((instruction, index) => {
                const stepDiv = document.createElement('div');
                stepDiv.className = `instruction-step ${index === stepIndex ? 'current-step' : ''}`;
                
                // Calculer la distance depuis la position actuelle
                let distance = 0;
                if (userMarker) {
                    distance = Math.round(map.distance(userMarker.getLatLng(), instruction.waypoint));
                }
                
                // Icône différente selon le type d'instruction
                let iconClass = 'fa-arrow-right';
                if (instruction.text.includes('à gauche')) iconClass = 'fa-arrow-turn-up-left';
                if (instruction.text.includes('à droite')) iconClass = 'fa-arrow-turn-up-right';
                if (instruction.text.includes('continuer tout droit')) iconClass = 'fa-arrow-up';
                if (instruction.text.includes('destination')) iconClass = 'fa-flag-checkered';
                
                stepDiv.innerHTML = `
                    <i class="fas ${iconClass}"></i>
                    <span>${instruction.text}</span>
                    <span class="distance-info">${distance}m</span>
                `;
                instructionsContainer.appendChild(stepDiv);
            });
            
            // Faire défiler jusqu'à l'étape actuelle
            const currentStep = instructionsContainer.querySelector('.current-step');
            if (currentStep) {
                currentStep.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }
        
        function checkProgress(currentPos, instructions) {
            // Trouver l'étape la plus proche
            let closestInstruction = null;
            let minDistance = Infinity;
            
            instructions.forEach((instruction, index) => {
                const distance = map.distance(currentPos, instruction.waypoint);
                if (distance < minDistance) {
                    minDistance = distance;
                    closestInstruction = index;
                }
            });
            
            // Mettre à jour le panneau d'instructions si on est proche d'une nouvelle étape
            if (closestInstruction !== null && minDistance < 30 && closestInstruction !== currentStepIndex) {
                updateInstructionPanel(instructions, closestInstruction);
            }
            
            // Mettre à jour les distances affichées
            const distanceElements = document.querySelectorAll('.distance-info');
            instructions.forEach((instruction, index) => {
                const distance = Math.round(map.distance(currentPos, instruction.waypoint));
                if (distanceElements[index]) {
                    distanceElements[index].textContent = `${distance}m`;
                    
                    // Changer la couleur si on est très proche
                    if (distance < 20) {
                        distanceElements[index].style.background = '#4CAF50';
                    } else {
                        distanceElements[index].style.background = '#334155';
                    }
                }
            });
        }
        
        function handleGeolocationError(error) {
            document.getElementById('gps-loading').style.display = 'none';
            
            let message = "Erreur de géolocalisation : ";
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message += "Vous avez refusé la géolocalisation. Activez-la dans les paramètres de votre navigateur.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    message += "La position n'a pas pu être déterminée. Vérifiez votre connexion.";
                    break;
                case error.TIMEOUT:
                    message += "La requête a expiré. Vérifiez votre connexion Internet.";
                    break;
                default:
                    message += "Erreur inconnue.";
            }
            
            // Afficher un message d'erreur
            const errorDiv = document.createElement('div');
            errorDiv.className = 'gps-error-message';
            errorDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i>
                <span>${message}</span>
            `;
            document.querySelector('.map-wrapper').appendChild(errorDiv);
            
            setTimeout(() => {
                errorDiv.style.opacity = '0';
                setTimeout(() => errorDiv.remove(), 500);
            }, 5000);
            
            map.setView(mirrorDoorCoords, 17);
            
            // Afficher quand même l'itinéraire depuis le centre-ville par défaut
            const defaultStart = [47.7465, 7.3390];
            calculateRoute(defaultStart);
        }
        
        function showMap() {
            isMapOpen = true;
            document.getElementById('map-container').style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            if (!map) {
                initMap();
            } else {
                // Recentrer sur la position de l'utilisateur si disponible
                if (userMarker) {
                    map.setView(userMarker.getLatLng(), 17);
                }
            }
            
            clearTimeout(typingTimeout);
        }
        
        function hideMap() {
            isMapOpen = false;
            document.getElementById('map-container').style.display = 'none';
            document.body.style.overflow = 'auto';
            
            if (phraseIndex < phrases.length && charIndex < phrases[phraseIndex].length) {
                typeWriter();
            }
        }
        
        function cleanupMap() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
            }
            if (map) {
                map.remove();
                map = null;
            }
        }
        
        function typeWriter() {
            if (isMapOpen) return;

            isTyping = true;
            if (phraseIndex < phrases.length) {
                if (charIndex < phrases[phraseIndex].length) {
                    if (phraseIndex === 0) {
                        const baseText = "Before I tell you my story, come and see me at the ";
                        const linkText = "mirror door";
                        
                        if (charIndex < baseText.length) {
                            dialogueElement.innerHTML = baseText.substring(0, charIndex + 1);
                            charIndex++;
                        } else {
                            const linkPos = charIndex - baseText.length;
                            if (linkPos < linkText.length) {
                                if (linkPos === 0) {
                                    dialogueElement.innerHTML = baseText + 
                                        '<span class="dialogue-link" id="mirror-door-link">' + 
                                        linkText.substring(0, linkPos + 1) + '</span>';
                                } else {
                                    const link = document.getElementById('mirror-door-link');
                                    if (link) {
                                        link.textContent = linkText.substring(0, linkPos + 1);
                                    }
                                }
                                charIndex++;
                            }
                        }
                    } else {
                        dialogueElement.innerHTML = phrases[phraseIndex].substring(0, charIndex + 1);
                        charIndex++;
                    }
                    
                    typingTimeout = setTimeout(typeWriter, 50);
                } else {
                    isTyping = false;
                    if (phraseIndex === 0) {
                        const link = document.getElementById('mirror-door-link');
                        if (link) {
                            link.addEventListener('click', function(e) {
                                e.preventDefault();
                                showMap();
                            });
                        }
                    }
                }
            }
        }
        
        function nextPhrase() {
            if (isMapOpen) return;

            if (isTyping) {
                if (phraseIndex === 0) {
                    dialogueElement.innerHTML = "Before I tell you my story, come and see me at the " +
                        '<span class="dialogue-link" id="mirror-door-link">mirror door</span>';
                    
                    const link = document.getElementById('mirror-door-link');
                    if (link) {
                        link.addEventListener('click', function(e) {
                            e.preventDefault();
                            showMap();
                        });
                    }
                } else {
                    dialogueElement.innerHTML = phrases[phraseIndex];
                }
                charIndex = phrases[phraseIndex].length;
                isTyping = false;
                clearTimeout(typingTimeout);
                return;
            }
            
            phraseIndex++;
            charIndex = 0;
            dialogueElement.innerHTML = '';
            if (phraseIndex < phrases.length) {
                typeWriter();
            }
        }
        
        window.onload = function() {
            setTimeout(typeWriter, 500);
            
            // Bouton de fermeture
            document.getElementById('close-map').addEventListener('click', hideMap);
            
            // Bouton de localisation
            document.getElementById('locate-btn').addEventListener('click', function() {
                if (userMarker) {
                    map.setView(userMarker.getLatLng(), 17);
                    
                    // Petite animation de feedback
                    this.style.transform = 'scale(1.1)';
                    this.style.background = '#3b82f6';
                    this.querySelector('i').style.color = 'white';
                    
                    setTimeout(() => {
                        this.style.transform = 'scale(1)';
                        this.style.background = 'rgba(255, 255, 255, 0.9)';
                        this.querySelector('i').style.color = '#1e40af';
                    }, 300);
                }
            });
        };
        
        window.onbeforeunload = function() {
            cleanupMap();
        };
        
        document.addEventListener('click', nextPhrase);
    </script>
</body>

</html>