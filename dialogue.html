<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pigeon Adventure GPS</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <!-- Font Awesome pour les icônes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            overflow: hidden;
            touch-action: manipulation;
        }

        #map-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #121a25;
            z-index: 1000;
            flex-direction: column;
        }

        .map-wrapper {
            position: relative;
            width: 100%;
            height: 70%;
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        #close-map {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: white;
            font-size: 18px;
            cursor: pointer;
            z-index: 1001;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        #instructions-container {
            background: #1e293b;
            color: #fff;
            padding: 0;
            height: 30%;
            max-height: 30%;
            display: flex;
            flex-direction: column;
            border-top: 2px solid #334155;
        }

        .instructions-header {
            background: #0f172a;
            padding: 10px 15px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #334155;
        }

        #instructions {
            flex: 1;
            overflow-y: auto;
            padding: 10px 15px;
            scroll-behavior: smooth;
        }

        .instruction-step {
            margin-bottom: 12px;
            padding: 10px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.05);
            border-left: 3px solid transparent;
            display: flex;
            align-items: center;
        }

        .current-step {
            background: rgba(59, 130, 246, 0.15);
            border-left: 3px solid #3b82f6;
            font-weight: 500;
        }

        .distance-info {
            margin-left: auto;
            background: #334155;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            color: #e2e8f0;
        }

        .locate-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .locate-btn i {
            color: #1e40af;
            font-size: 20px;
        }

        .pulse-dot {
            position: absolute;
            width: 16px;
            height: 16px;
            background-color: #3b82f6;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            animation: pulse 2s infinite;
        }

        .inner-dot {
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: white;
            border-radius: 50%;
            top: 6px;
            left: 6px;
            z-index: 2;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            70% { transform: scale(3); opacity: 0; }
            100% { transform: scale(1); opacity: 0; }
        }
    </style>
</head>

<body>
    <div id="map-container">
        <div class="map-wrapper">
            <div id="map"></div>
            <button id="close-map" title="Fermer la carte"><i class="fas fa-times"></i></button>
            <button class="locate-btn" id="locate-btn" title="Centrer sur ma position"><i class="fas fa-location-arrow"></i></button>
        </div>
        
        <div id="instructions-container">
            <div class="instructions-header">
                <span>Directions vers Mirror Door</span>
                <span id="total-distance">--</span>
            </div>
            <div id="instructions"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

    <script>
        // Coordonnées exactes de la mirror door
        const mirrorDoorCoords = [47.748381528597086, 7.333458419631289];
        let map, routingControl, userMarker, watchId;
        let currentRouteInstructions = [];
        let currentStepIndex = 0;
        let totalDistance = 0;

        function initMap() {
            // Créer la carte centrée sur la destination
            map = L.map('map', {
                zoomControl: false
            }).setView(mirrorDoorCoords, 17);
            
            // Ajouter la couche de tuiles OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            // Marqueur pour la destination (mirror door)
            L.marker(mirrorDoorCoords).addTo(map)
                .bindPopup("<b>Mirror Door</b><br>Destination")
                .openPopup();
            
            // Démarrer le suivi GPS
            startGPSTracking();
        }
        
        function startGPSTracking() {
            if (navigator.geolocation) {
                const options = {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                };
                
                watchId = navigator.geolocation.watchPosition(
                    position => updatePosition(position),
                    error => handleGeolocationError(error),
                    options
                );
            } else {
                alert("La géolocalisation n'est pas supportée par votre navigateur.");
                map.setView(mirrorDoorCoords, 17);
            }
        }
        
        function updatePosition(position) {
            const userCoords = [position.coords.latitude, position.coords.longitude];
            const accuracy = position.coords.accuracy;
            
            // Créer ou mettre à jour le marqueur de position
            if (!userMarker) {
                userMarker = L.marker(userCoords, {
                    icon: L.divIcon({
                        className: 'user-location-marker',
                        html: '<div class="pulse-dot"></div><div class="inner-dot"></div>',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    })
                }).addTo(map);
                
                // Ajouter un cercle de précision
                L.circle(userCoords, {
                    color: '#3b82f6',
                    fillColor: '#3b82f6',
                    fillOpacity: 0.2,
                    radius: accuracy
                }).addTo(map);
                
                // Calculer l'itinéraire initial
                calculateRoute(userCoords);
                
                // Centrer la carte sur la position
                map.setView(userCoords, 17);
            } else {
                userMarker.setLatLng(userCoords);
                
                // Mettre à jour le cercle de précision
                if (userMarker.accuracyCircle) {
                    userMarker.accuracyCircle.setLatLng(userCoords).setRadius(accuracy);
                }
            }
            
            // Vérifier la progression vers la destination
            if (currentRouteInstructions.length > 0) {
                checkProgress(userCoords, currentRouteInstructions);
            }
        }
        
        function calculateRoute(startCoords) {
            if (routingControl) {
                map.removeControl(routingControl);
            }
            
            // Configurer le contrôle d'itinéraire
            routingControl = L.Routing.control({
                waypoints: [
                    L.latLng(startCoords[0], startCoords[1]),
                    L.latLng(mirrorDoorCoords[0], mirrorDoorCoords[1])
                ],
                routeWhileDragging: false,
                showAlternatives: false,
                fitSelectedRoutes: false,
                show: false,
                collapsible: true,
                addWaypoints: false,
                draggableWaypoints: false,
                language: 'fr',
                lineOptions: {
                    styles: [{color: '#3b82f6', opacity: 0.9, weight: 6}]
                },
                createMarker: function() { return null; }
            }).addTo(map);
            
            // Écouter les événements de routage
            routingControl.on('routesfound', function(e) {
                const routes = e.routes;
                const instructions = routes[0].instructions;
                currentRouteInstructions = instructions;
                totalDistance = Math.round(routes[0].summary.totalDistance);
                
                // Mettre à jour la distance totale
                document.getElementById('total-distance').textContent = `${totalDistance} m`;
                
                // Mettre à jour le panneau d'instructions
                updateInstructionPanel(instructions, 0);
            });
        }
        
        function updateInstructionPanel(instructions, stepIndex) {
            const instructionsContainer = document.getElementById('instructions');
            instructionsContainer.innerHTML = '';
            currentStepIndex = stepIndex;
            
            instructions.forEach((instruction, index) => {
                const stepDiv = document.createElement('div');
                stepDiv.className = `instruction-step ${index === stepIndex ? 'current-step' : ''}`;
                
                // Calculer la distance depuis la position actuelle
                let distance = 0;
                if (userMarker) {
                    distance = Math.round(map.distance(userMarker.getLatLng(), instruction.waypoint));
                }
                
                // Icône différente selon le type d'instruction
                let iconClass = 'fa-arrow-right';
                if (instruction.text.includes('à gauche')) iconClass = 'fa-arrow-turn-up-left';
                if (instruction.text.includes('à droite')) iconClass = 'fa-arrow-turn-up-right';
                if (instruction.text.includes('continuer tout droit')) iconClass = 'fa-arrow-up';
                if (instruction.text.includes('destination')) iconClass = 'fa-flag-checkered';
                
                stepDiv.innerHTML = `
                    <i class="fas ${iconClass}"></i>
                    <span>${instruction.text}</span>
                    <span class="distance-info">${distance}m</span>
                `;
                instructionsContainer.appendChild(stepDiv);
            });
            
            // Faire défiler jusqu'à l'étape actuelle
            const currentStep = instructionsContainer.querySelector('.current-step');
            if (currentStep) {
                currentStep.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }
        
        function checkProgress(currentPos, instructions) {
            // Trouver l'étape la plus proche
            let closestInstruction = null;
            let minDistance = Infinity;
            
            instructions.forEach((instruction, index) => {
                const distance = map.distance(currentPos, instruction.waypoint);
                if (distance < minDistance) {
                    minDistance = distance;
                    closestInstruction = index;
                }
            });
            
            // Mettre à jour le panneau d'instructions si on est proche d'une nouvelle étape
            if (closestInstruction !== null && minDistance < 30 && closestInstruction !== currentStepIndex) {
                updateInstructionPanel(instructions, closestInstruction);
            }
            
            // Mettre à jour les distances affichées
            const distanceElements = document.querySelectorAll('.distance-info');
            instructions.forEach((instruction, index) => {
                const distance = Math.round(map.distance(currentPos, instruction.waypoint));
                if (distanceElements[index]) {
                    distanceElements[index].textContent = `${distance}m`;
                    
                    // Changer la couleur si on est très proche
                    if (distance < 20) {
                        distanceElements[index].style.background = '#4CAF50';
                    } else {
                        distanceElements[index].style.background = '#334155';
                    }
                }
            });
        }
        
        function handleGeolocationError(error) {
            let message = "Erreur de géolocalisation : ";
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message += "Vous avez refusé la géolocalisation.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    message += "La position n'a pas pu être déterminée.";
                    break;
                case error.TIMEOUT:
                    message += "La requête a expiré.";
                    break;
                default:
                    message += "Erreur inconnue.";
            }
            
            alert(message);
            map.setView(mirrorDoorCoords, 17);
            
            // Afficher quand même l'itinéraire depuis le centre-ville par défaut
            const defaultStart = [47.7465, 7.3390];
            calculateRoute(defaultStart);
        }
        
        function showMap() {
            document.getElementById('map-container').style.display = 'flex';
            if (!map) {
                initMap();
            }
        }
        
        function hideMap() {
            document.getElementById('map-container').style.display = 'none';
        }
        
        function cleanupMap() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
            }
            if (map) {
                map.remove();
                map = null;
            }
        }
        
        window.onload = function() {
            // Bouton de fermeture
            document.getElementById('close-map').addEventListener('click', hideMap);
            
            // Bouton de localisation
            document.getElementById('locate-btn').addEventListener('click', function() {
                if (userMarker) {
                    map.setView(userMarker.getLatLng(), 17, {
                        animate: true,
                        duration: 0.5
                    });
                }
            });
        };
        
        window.onbeforeunload = function() {
            cleanupMap();
        };
    </script>
</body>

</html>